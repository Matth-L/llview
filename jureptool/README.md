Jureptool  
This program is part of LLview.  
Copyright (c) 2023 Forschungszentrum Juelich GmbH, Juelich Supercomputing Centre  
http://www.fz-juelich.de/jsc/llview  

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program. If not, see http://www.gnu.org/licenses/.

----

# JuRepTool
## Detailed Job Report Generation Script

JÃ¼lich Reporting Tool: This program reads the data information generated by LLview and create PDF and HTML reports for running and recently-finished jobs. It uses Python's `multiprocessing` library to parallelize over the reports.

The configuration of the script and plots are given in 4 YAML files:
- `config.yml`: General configuration such as fontsize, page size, colors, etc.
- `system_info.yml`: Information on the system names, queues and sizes (cores, memory)
- `plots.yml`: Configuration of the sections and graphs to be plotted in each of them. Keywords from `system_info.yml` may be used in ylim.
- `logging.yml`: Logging information (filename, format, level)

Options that can be passed via SLURM `--comment` flag:
- `llview_plot_lines`: plot lines instead of colorplots (when `gpus=True` and `num_gps<=16`, or `gpus=False` and `num_gpus<=16`)


### Usage:
```
usage: main.py [-h] [--daemon] [--demo] [--nomove] [--nohtml] [--gzip] [--maxjobs MAXJOBS] [--maxsec MAXSEC] [--shutdown SHUTDOWN [SHUTDOWN ...]]
               [--nprocs NPROCS] [--loglevel LOGLEVEL] [--logprefix LOGPREFIX] [--configfolder CONFIGFOLDER] [--outfolder OUTFOLDER] [--semail SEMAIL] [--remail REMAIL]
               file [file ...]

JuRepTool

positional arguments:
  file                  File including list of running and recently-finished jobs or JSON file of a job

optional arguments:
  -h, --help            show this help message and exit
  --daemon              Run as a 'daemon', i.e., in an infinite loop
  --demo                Run in 'demo' mode (hide usernames, project id and job names)
  --nomove              Don't copy files to final location
  --nohtml              Deactivate generation of HTML
  --gzip                Compress HTML using gzip
  --maxjobs MAXJOBS     Maximum number of jobs to process (default: MAXJOBS=10000)
  --maxsec MAXSEC       Filter date range with maximum seconds range (default: no filter)
  --shutdown SHUTDOWN [SHUTDOWN ...]
                        File(s) that triggers the script to shutdown
  --nprocs NPROCS       Number of process to run in parallel (default: NPROCS=2)
  --loglevel LOGLEVEL   Select log level: 'DEBUG', 'INFO', 'WARNING', 'ERROR' (more to less verbose)
  --logprefix LOGPREFIX
                        Prefix for the daily log and errlog files
  --configfolder CONFIGFOLDER
                        Folder with YAML configuration files (default: src/../../configs/jureptool)
  --outfolder OUTFOLDER
                        Folder to store temporary and demo PDFs
  --semail SEMAIL       Sender email to use in case of errors (default: None)
  --remail REMAIL       Receiver email to use in case of errors (default: None)
```

In the current version, the pdfs are (temporarily) written to a local `./results` folder (it may be necessary to create it).

### Dependencies:

* matplotlib (>3.5.0)
* numpy
* pandas
* pyyaml
* plotly
* cmcrameri
* python compiled with gzip option (if compressed HTML are to be generated with option `--gzip`)

### After installation

* Install dependencies: `pip install numpy pandas matplotlib plotly PyYAML cmcrameri`.
* Check `${LLVIEW_CONF}/jureptool` for prefix to be included in plotlists.dat items
* `mkdir ./results`
* Add required fonts (Liberation Sans or Arial, Liberation Mono or Courier New). Liberation fonts are free and can be downloaded from https://github.com/liberationfonts/liberation-fonts/releases.
Fonts can be installed with:
```
mkdir ~/.local/share/fonts/
cp <fonts_folder>/*.ttf ~/.local/share/fonts/
fc-cache -f
rm -fr ~/.cache/matplotlib
```
(on MacOs, matplotlib's cache folder is `~/.matplotlib`.)

### Docker

A Docker image is provided to run Jureptool. Jureptool requires access to the config folder and the file argument.

You will need to pass these arguments using mounted volumes in Docker. See the example below :
```sh
# pwd = llview/jureptool
docker build -t jureptool .

docker run \
  -v $(pwd)/configs:/jureptool/configs \
  -v $(pwd)/folder:/jureptool/folder \
  jureptool --configfolder configs folder
```


### Expected file

JuRepTool uses `.json` to create PDF and HTML. The expected `.json` files are as follows:

```json
{
  "cpu": {
    "currentwatts_avg": null,
    "currentwatts_max": null,
    "currentwatts_min": null,
    "load_avg": null,
    "load_max": null,
    "load_min": null,
    "usage_avg": null,
    "usage_max": null,
    "usage_min": null,
    "used_cores_avg": null,
    "used_cores_logic_avg": null,
    "used_cores_logic_max": null,
    "used_cores_logic_min": null,
    "used_cores_max": null,
    "used_cores_min": null,
    "used_cores_phys_avg": null,
    "used_cores_phys_max": null,
    "used_cores_phys_min": null,
    "used_mem_avg": null,
    "used_mem_max": null,
    "used_mem_min": null
  },

  "fabric": {
    "mbin_avg": null,
    "mbin_max": null,
    "mbin_min": null,
    "mbout_avg": null,
    "mbout_max": null,
    "mbout_min": null,
    "pckin_avg": null,
    "pckin_max": null,
    "pckin_min": null,
    "pckout_avg": null,
    "pckout_max": null,
    "pckout_min": null
  },

  "files": {
    "coreusagenodefile": "",
    "fabricnodefile": "",
    "fsallnodefile": "",
    "fsfastdatanodefile": "",
    "fshomenodefile": "",
    "fsprojectnodefile": "",
    "fsscratchnodefile": "",
    "gpunodefile": "",
    "htmlfile": "",
    "jmcfile": "",
    "loadmemnodefile": "",
    "pdffile": ""
  },

  "fs": {
    "fs_all_Mbr_sum": null,
    "fs_all_MbrR_max": null,
    "fs_all_Mbw_sum": null,
    "fs_all_MbwR_max": null,
    "fs_all_ocR_max": null,

    "fs_fastdata_Mbr_sum": null,
    "fs_fastdata_MbrR_max": null,
    "fs_fastdata_Mbw_sum": null,
    "fs_fastdata_MbwR_max": null,
    "fs_fastdata_ocR_max": null,

    "fs_home_Mbr_sum": null,
    "fs_home_MbrR_max": null,
    "fs_home_Mbw_sum": null,
    "fs_home_MbwR_max": null,
    "fs_home_ocR_max": null,

    "fs_project_Mbr_sum": null,
    "fs_project_MbrR_max": null,
    "fs_project_Mbw_sum": null,
    "fs_project_MbwR_max": null,
    "fs_project_ocR_max": null,

    "fs_scratch_Mbr_sum": null,
    "fs_scratch_MbrR_max": null,
    "fs_scratch_Mbw_sum": null,
    "fs_scratch_MbwR_max": null,
    "fs_scratch_ocR_max": null
  },

  "gpu": {
    "gpu_active_avg": null,
    "gpu_clk_max": null,
    "gpu_memu_avg": null,
    "gpu_memu_max": null,
    "gpu_memur_avg": null,
    "gpu_pu_avg": null,
    "gpu_pu_max": null,
    "gpu_sclk_max": null,
    "gpu_temp_avg": null,
    "gpu_temp_max": null,
    "gpu_util_avg": null,
    "gpulist": "",
    "gpuspec": ""
  },

  "IC": {
    "icgroupmap": ""
  },

  "jmc": {
    "descs": "",
    "maximums": "",
    "minimums": "",
    "names": "",
    "numvars": 0
  },

  "job": {
    "account": "",
    "command": "",
    "comment": "",
    "endedhm": "",
    "estendtime": "",
    "finished": null,
    "jobid": "",
    "lastupdate": "",
    "lastupdatets": null,
    "name": "",
    "nodelist": "",
    "numgpus": null,
    "numnodes": null,
    "owner": "",
    "queue": "",
    "queuedate": "",
    "runtime": null,
    "runtimehm": "",
    "runtimeperc": null,
    "starttime": "",
    "system": "",
    "updatetime": "",
    "waittime": "",
    "wallh": null,
    "wallhm": ""
  },

  "num_datapoints": {
    "cores_ndps": null,
    "fa_ndps": null,
    "fs_all_ndps": null,
    "fs_fastdata_ndps": null,
    "fs_home_ndps": null,
    "fs_project_ndps": null,
    "fs_scratch_ndps": null,
    "gpu_ndps": null,
    "jmc_ndps": null,
    "ld_ndps": null
  },

  "rc": {
    "errmsgnodes": "",
    "errmsgs": "",
    "max_rc": null,
    "nsteps": null,
    "numerrnodes": null,
    "nummsgs": null,
    "rc_rc": null,
    "rc_signr": null,
    "rc_state": "",
    "rc_wallh": null,
    "stepspec": ""
  }
}

```